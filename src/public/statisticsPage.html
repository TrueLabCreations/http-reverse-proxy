<html>
  <head>
    <title>Http Proxy Statistics</title>
    <style>
      table {
        border-collapse: collapse;
      }
      tr:nth-child(odd) {
        background-color: lightgrey;
        font-weight: bold;
      }
      th {
        padding: 10px;
        background-color: grey;
        color: white;
        font-size: 16pt;
      }
      td {
        padding: 5px;
      }
      td:nth-child(2),
      td:nth-child(3) {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>
      Http Proxy server statistics
    </h1>

    <button onclick="startService()">Start</button>

    <button onclick="stopService()">Stop</button>

    <hr />

    <!-- <textarea id="log"></textarea> -->
    <div id="output"></div>

    <script>
      var ws = null;
      var priorEvents = {};

      function startService() {
        if (!ws) {
          startWebsocket();
        }
      }

      function stopService() {
        if (ws) {
          ws.send(`{"command": "stop"}`);
          // ws.close()
        }
      }

      function buildEventTable(events) {
        const eventTable = {};
        const workerIds = [];

        Object.keys(events).forEach(property => {
          const workerId = property.match(/^\d+/)[0];
          const name = property
            .replace(/^\d+:/, "")
            .replace(/[A-Z]/g, c => ` ${c}`)
            .replace(/:/g, ": ")
            .trim();

          if (!eventTable[name]) {
            eventTable[name] = {};
          }

          eventTable[name][workerId] = events[property];

          if (workerIds.indexOf(workerId) < 0) {
            workerIds.push(workerId);
          }
        });

        return {
          workerIds: workerIds.sort((a, b) => a - b),
          eventTable: eventTable
        };
      }

      function buildWorkerColumns(eventEntry, priorEntry, workerIds) {
        let total = 0;
        let delta = 0;
        const columns = [];

        workerIds.forEach(workerId => {
          const fields = ["<td>"];

          if (eventEntry[workerId]) {
            fields.push(eventEntry[workerId]);

            total += eventEntry[workerId];

            fields.push("/");

            if (priorEntry && priorEntry[workerId]) {
              fields.push(eventEntry[workerId] - priorEntry[workerId]);
              delta += eventEntry[workerId] - priorEntry[workerId];
            } else {
              fields.push("0");
            }
          }
          fields.push("</td>");

          columns.push(fields.join(""));
        });

        columns.unshift(`<td>${total}/${delta}</td>`);

        return columns.join("");
      }

      function startWebsocket() {
        ws = new WebSocket(
          `ws://${window.location.hostname}:${window.location.port}${window.location.pathname}`
        );

        ws.onopen = event => {
          ws.send(`{"command": "start"}`);
        };

        ws.onmessage = event => {
          el = document.getElementById("output");

          if (el) {
            const { workerIds, eventTable } = buildEventTable(
              JSON.parse(event.data)
            );
            const names = Object.keys(eventTable).sort();

            rows = names
              .map(
                (name, index) =>
                  `<tr><td>${name}</td>${buildWorkerColumns(
                    eventTable[name],
                    priorEvents[name],
                    workerIds
                  )}</tr>`
              )
              .join("");

            el.innerHTML =
              `<table><thead><tr><th>Metric</th><th>Total</th>${workerIds
                .map(
                  workerId =>
                    "<th>" +
                    (workerId < 10 ? "0" + workerId.toString() : workerId) +
                    "</th>"
                )
                .join("")}
                </tr></thead><tbody>` +
              rows +
              "</tbody></table>";
            priorEvents = eventTable;
          }
        };

        ws.onerror = event => {
          alert(`Websocket error. Target ${event.target}`);
          ws = null;
        };

        ws.onclose = event => {
          ws = null;
        };
      }
    </script>
  </body>
</html>
